<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="./css/style.css" />
    <title>Synth</title>
  </head>
  <body>
    <div class="" id="root" data-name="root">
      <div
        class="w-full h-screen p-2 rounded shadow bg-neutral-200"
        id="synthHolder"
      >
        <div class="visualizer bg-white my-2 w-full h-1/2">
          <canvas
            class=""
            id="oscilloscope"
            width="1000px"
            height="200px"
          ></canvas>
        </div>
        <div class="synthesizer bg-neutral-700 my-2 w-full h-fit">
          <div class="octave-holder flex p-2">
            <!-- <div class="gain-div p-2 bg-white rounded shadow">
              <label for="volume"
                >Gain Current-:<span id="gainValue">0.5</span></label
              >
              <input
                type="range"
                min="0"
                max="1"
                step="0.1"
                id="volume"
                name="volume"
                value="0.5"
              />
            </div>
            <div class="wave-holder p-2 bg-white rounded shadow">
              <label for="wave-type"> Wave Type </label>
              <select name="wave-type" id="waveType">
                <option value="sine">Sine</option>
                <option value="square">Square</option>
                <option value="triangle">Triangle</option>
                <option value="custom">Custom</option>
              </select>
            </div> -->

            <label
              class="relative flex justify-between items-center p-2 text-xl bg-white rounded"
              ><span>Off</span>
              <input
                id="toggle"
                type="checkbox"
                class="absolute left-1/2 -translate-x-1/2 w-full h-full peer appearance-none rounded-md"
              />
              <span
                class="w-16 h-10 flex items-center flex-shrink-0 ml-4 p-1 bg-gray-300 rounded-full duration-300 ease-in-out peer-checked:bg-green-400 after:w-8 after:h-8 after:bg-white after:rounded-full after:shadow-md after:duration-300 peer-checked:after:translate-x-6"
              ></span>
              <span class="inline-block ml-4">On</span>
            </label>
          </div>

          <div
            class="keyHolder w-[60%] h-[40vh] p-2 shadow flex justify-start items-start relative"
          >
            <div
              class="whiteKeyHolder h-full w-full flex justify-start bg-gray-200 p-2 rounded"
            >
              <div
                class="whiteBtnHolder bg-white h-full w-[5%] rounded shadow-[inset_0_-2px_4px_rgba(0,0,5,0.3)]"
              >
                <button class="w-full h-full"></button>
              </div>
              <div
                class="whiteBtnHolder bg-white h-full w-[5%] rounded shadow-[inset_0_-2px_4px_rgba(0,0,5,0.3)]"
              >
                <button class="w-full h-full"></button>
              </div>
              <div
                class="whiteBtnHolder bg-white h-full w-[5%] rounded shadow-[inset_0_-2px_4px_rgba(0,0,5,0.3)]"
              >
                <button class="w-full h-full"></button>
              </div>
              <div
                class="whiteBtnHolder bg-white h-full w-[5%] rounded shadow-[inset_0_-2px_4px_rgba(0,0,5,0.3)]"
              >
                <button class="w-full h-full"></button>
              </div>
              <div
                class="whiteBtnHolder bg-white h-full w-[5%] rounded shadow-[inset_0_-2px_4px_rgba(0,0,5,0.3)]"
              >
                <button class="w-full h-full"></button>
              </div>
              <div
                class="whiteBtnHolder bg-white h-full w-[5%] rounded shadow-[inset_0_-2px_4px_rgba(0,0,5,0.3)]"
              >
                <button class="w-full h-full"></button>
              </div>
              <div
                class="whiteBtnHolder bg-white h-full w-[5%] rounded shadow-[inset_0_-2px_4px_rgba(0,0,5,0.3)]"
              >
                <button class="w-full h-full"></button>
              </div>
              <div
                class="whiteBtnHolder bg-white h-full w-[5%] rounded shadow-[inset_0_-2px_4px_rgba(0,0,5,0.3)]"
              >
                <button class="w-full h-full"></button>
              </div>
              <div
                class="whiteBtnHolder bg-white h-full w-[5%] rounded shadow-[inset_0_-2px_4px_rgba(0,0,5,0.3)]"
              >
                <button class="w-full h-full"></button>
              </div>
              <div
                class="whiteBtnHolder bg-white h-full w-[5%] rounded shadow-[inset_0_-2px_4px_rgba(0,0,5,0.3)]"
              >
                <button class="w-full h-full"></button>
              </div>
              <div
                class="whiteBtnHolder bg-white h-full w-[5%] rounded shadow-[inset_0_-2px_4px_rgba(0,0,5,0.3)]"
              >
                <button class="w-full h-full"></button>
              </div>
              <div
                class="whiteBtnHolder bg-white h-full w-[5%] rounded shadow-[inset_0_-2px_4px_rgba(0,0,5,0.3)]"
              >
                <button class="w-full h-full"></button>
              </div>
              <div
                class="whiteBtnHolder bg-white h-full w-[5%] rounded shadow-[inset_0_-2px_4px_rgba(0,0,5,0.3)]"
              >
                <button class="w-full h-full"></button>
              </div>
              <div
                class="whiteBtnHolder bg-white h-full w-[5%] rounded shadow-[inset_0_-2px_4px_rgba(0,0,5,0.3)]"
              >
                <button class="w-full h-full"></button>
              </div>
            </div>
            <div
              class="blackKeyHolder absolute w-full h-1/2 flex top-[17px] left-4"
            >
              <div
                class="blackBtnHolder w-[3%] h-full rounded-b ml-[40px] bg-black"
              >
                <button class="w-full h-full">2</button>
              </div>
              <div
                class="blackBtnHolder w-[3%] h-full rounded-b ml-[20px] bg-black"
              >
                <button class="w-full h-full">2</button>
              </div>
              <div
                class="blackBtnHolder w-[3%] h-full rounded-b ml-[75px] bg-black"
              >
                <button class="w-full h-full">2</button>
              </div>
              <div
                class="blackBtnHolder w-[3%] h-full rounded-b ml-[22px] bg-black"
              >
                <button class="w-full h-full">2</button>
              </div>
              <div
                class="blackBtnHolder w-[3%] h-full rounded-b ml-[22px] bg-black"
              >
                <button class="w-full h-full">2</button>
              </div>
              <div
                class="blackBtnHolder w-[3%] h-full rounded-b ml-[75px] bg-black"
              >
                <button class="w-full h-full">2</button>
              </div>
              <div
                class="blackBtnHolder w-[3%] h-full rounded-b ml-[22px] bg-black"
              >
                <button class="w-full h-full">2</button>
              </div>
              <div
                class="blackBtnHolder w-[3%] h-full rounded-b ml-[75px] bg-black"
              >
                <button class="w-full h-full">2</button>
              </div>
              <div
                class="blackBtnHolder w-[3%] h-full rounded-b ml-[22px] bg-black"
              >
                <button class="w-full h-full">2</button>
              </div>
              <div
                class="blackBtnHolder w-[3%] h-full rounded-b ml-[22px] bg-black"
              >
                <button class="w-full h-full">2</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </body>

  <script type="module">
    const toggle = document.querySelector('#toggle')
    const whiteKeyHolders = document.querySelectorAll('.whiteBtnHolder')
    const blackKeyHolders = document.querySelectorAll('.blackBtnHolder')

    const whiteKeys = [
      'q',
      'w',
      'e',
      'r',
      't',
      'y',
      'u',
      'i',
      'o',
      'p',
      '[',
      ']',
      '\\',
      'l',
    ]
    const blackKeys = ['2', '3', '5', '6', '7', '9', '0', '=', '/', '*']
    const whiteTones = 'CDEFGABCDEFGAB'
    const blackTones = 'C#,D#,F#,G#,A#,C#,D#,F#,G#,A#'
    const combined = 'C,C#,D,D#,E,F,F#,G,G#,A,A#,B'

    const initialFrequence = 261.6256
    const initialOctave = 4
    const canvas = document.getElementById('oscilloscope')
    const canvasCtx = canvas.getContext('2d')
    const audioContext = new AudioContext()
    const analyzer = audioContext.createAnalyser()

    const oscList = []

    const frequency = 0.005
    const amplitude = 50
    const speed = 0.05

    let start = false
    let phase = 0
    let mainGainNode = audioContext.createGain()
    let initAnimationToggle = false
    let raf
    let j = 0

    mainGainNode.connect(audioContext.destination)
    mainGainNode.gain.value = 0.5

    const initializeCanvas = () => {
      canvasCtx.fillStyle = 'black'
      canvasCtx.clearRect(0, 0, 1000, 5000)
      canvasCtx.fillRect(0, 0, 1000, 5000)
    }

    initializeCanvas()

    toggle.addEventListener('change', (e) => {
      start = !start
      if (start) {
        raf = requestAnimationFrame(draw)
      } else {
        cancelAnimationFrame(raf)
        initializeCanvas()
        initAnimationToggle = false
        j = 0
      }
    })

    whiteKeyHolders.forEach((btn, index) => {
      btn.setAttribute('data-key', whiteKeys[index])
      btn.setAttribute('data-tone', whiteTones[index])
      if (index < whiteKeyHolders.length / 2) {
        btn.setAttribute('data-octave', initialOctave)
      } else {
        btn.setAttribute('data-octave', initialOctave + 1)
      }
    })

    blackKeyHolders.forEach((btn, index) => {
      btn.setAttribute('data-key', blackKeys[index])
      btn.setAttribute('data-tone', blackTones.split(',')[index])
      if (index < blackKeyHolders.length / 2) {
        btn.setAttribute('data-octave', initialOctave)
      } else {
        btn.setAttribute('data-octave', initialOctave + 1)
      }
    })

    document.addEventListener('keydown', (e) => {
      if (!start) return alert('Synth is off')
      e.preventDefault()
      const indexWhite = [...whiteKeyHolders].findIndex(
        (node) => node.getAttribute('data-key') === e.key
      )
      if (indexWhite !== -1)
        return generateFrequence(whiteKeyHolders[indexWhite])

      const indexBlack = [...blackKeyHolders].findIndex(
        (node) => node.getAttribute('data-key') === e.key
      )

      if (indexBlack !== -1)
        return generateFrequence(blackKeyHolders[indexBlack])

      return
    })

    document.addEventListener('keyup', (e) => {
      const index = oscList.findIndex((node) => node.key === e.key)
      if (index == -1) return
      oscList[index].osc.stop()
      oscList.splice(index, 1)
    })

    const generateFrequence = (element) => {
      const octave = element.getAttribute('data-octave')
      const tone = element.getAttribute('data-tone')
      const key = element.getAttribute('data-key')
      const osc = oscList.find((node) => node.key === key)
      if (osc) return
      const index = combined.split(',').findIndex((node) => node === tone)
      if (octave === initialOctave) {
        playTone(freqCalc(index + getOctaveInitValue(initialOctave)), key)
      } else {
        playTone(freqCalc(index + getOctaveInitValue(initialOctave) + 12), key)
      }
    }

    const playTone = (freq, key) => {
      const osc = audioContext.createOscillator()
      mainGainNode.gain.linearRampToValueAtTime(
        1,
        audioContext.currentTime + 0.05
      )
      mainGainNode.gain.linearRampToValueAtTime(1, audioContext.currentTime + 2)
      osc.connect(mainGainNode)
      osc.connect(audioContext.destination)
      osc.type = 'triangle'
      osc.frequency.value = freq
      oscList.push({ osc, key })
      osc.start()
    }

    const freqCalc = (n) => {
      return Math.pow(2, (n - 49) / 12) * 440
    }

    const updateUI = (element) => {
      if (element.classList.contains('bg-white')) {
        element.classList.replace('bg-white', 'bg-lime-700')
      } else {
        element.classList.replace('bg-lime-700', 'bg-white')
      }
    }

    const getOctaveInitValue = (octave) => {
      switch (octave) {
        case 1:
          return 4
        case 2:
          return 16
        case 3:
          return 28
        case 4:
          return 40
        case 5:
          return 52
        case 6:
          return 64
        default:
          return 4
      }
    }

    const onAnimationText = () => {
      canvasCtx.font = '30px serif'
      canvasCtx.fillStyle = 'red'
      canvasCtx.fillText('Hello Synth', 800 / 2, 180 / 2)
    }

    const onAnimationWave = () => {
      canvasCtx.fillStyle = 'rgba(255,0,0,0.4)'

      for (let i = 0; i < 1000; i += 10) {
        var y = 250 / 2 + Math.sin(i * frequency + phase) * amplitude
        canvasCtx.fillRect(i, y, 3, 200 - y)
      }
    }

    const onAnimation = () => {
      onAnimationText()
      onAnimationWave()
      j += 5
      if (j % 1000 === 0) initAnimationToggle = false
    }

    const draw = () => {
      initializeCanvas()
      if (!initAnimationToggle) onAnimation()
      phase += speed
      raf = requestAnimationFrame(draw)
    }
  </script>
</html>
